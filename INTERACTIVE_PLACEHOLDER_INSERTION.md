# 交互式占位符插入功能说明

## 🎯 功能概述

基于**"看哪里，点哪里，插哪里"**的设计理念，我们实现了直观的占位符插入体验。

### 核心交互

```
用户思维路径：
"我想在这里加个姓名"
        ↓
    双击该位置
        ↓
    选择"姓名"占位符
        ↓
    立即插入 [姓名 📝]
```

---

## ✨ 主要功能

### 1. 双击插入 🖱️

**操作：** 在模式2（占位符管理模式）的文档预览区双击任意位置

**效果：**
```
┌────────────────────────────────────┐
│  插入占位符                         │
├────────────────────────────────────┤
│  [🔍 搜索占位符...]                │
│                                    │
│  常用占位符：                       │
│  📝 姓名 (name)                    │
│  📅 出生日期 (birthday)            │
│  📍 住址 (address)                 │
│  ...                               │
│                                    │
│  [取消]  [➕ 创建新占位符]          │
└────────────────────────────────────┘
```

**特点：**
- ✅ 即时响应，无延迟
- ✅ 搜索功能（支持字段名和标签）
- ✅ 常用占位符快速选择
- ✅ 滚动查看所有占位符

---

### 2. 右键菜单 📋

**操作：** 在文档预览区右键点击

**菜单选项：**
```
┌────────────────────┐
│ ➕ 插入占位符      │
│ ✏️  插入文本        │
└────────────────────┘
```

**用途：**
- 快速访问插入功能
- 高级用户的快捷方式

---

### 3. 智能搜索 🔍

**功能：** 在插入器中输入关键词快速查找

**搜索范围：**
- 占位符标签（如"姓名"）
- 字段名（如"name"）

**智能提示：**
- 无结果时提示创建新占位符
- 搜索词自动填充为字段名

**示例：**
```
搜索 "身份证" →
  找到: 📝 身份证号 (id_card)
  
搜索 "abcd" →
  未找到 → [➕ 创建新占位符]
  → 自动填充字段名: abcd
```

---

### 4. 快速创建 ➕

**触发方式：**
1. 插入器底部的"创建新占位符"按钮
2. 搜索无结果时自动建议

**创建流程：**
```
点击"创建新占位符"
        ↓
┌──────────────────────────────┐
│  创建新占位符                 │
├──────────────────────────────┤
│  字段名: [new_field____]     │
│  标签:   [新字段_______]     │
│  类型:   文本 ▼              │
│  ...                         │
│                              │
│  [返回]  [创建并插入]         │
└──────────────────────────────┘
        ↓
   自动插入到文档
```

**智能填充：**
- 搜索词自动转换为字段名（小写、下划线）
- 搜索词作为默认标签

---

### 5. 点击chip配置 🏷️

**操作：** 点击文档中的彩色chip

**效果：** 打开配置对话框，编辑占位符元数据

**支持配置：**
- 标签、类型、描述
- 验证规则、默认值
- 格式化选项

---

## 📊 使用场景

### 场景1：在指定位置添加占位符

**用户需求：** 在"姓名：______"后面加个占位符

**操作步骤：**
1. 进入模式2（占位符管理模式）
2. 双击"姓名："后面的空白处
3. 在弹出的插入器中选择"姓名"
4. 立即显示为 `姓名：[姓名 📝]`

**耗时：** < 5秒 ⚡

---

### 场景2：创建并插入新占位符

**用户需求：** 需要一个"联系电话"占位符，但列表里没有

**操作步骤：**
1. 双击要插入的位置
2. 搜索"联系电话"（无结果）
3. 点击"创建新占位符"
4. 填写配置信息
5. 点击"创建并插入"

**耗时：** < 15秒 ⚡

---

### 场景3：批量插入占位符

**用户需求：** 在多个位置插入不同占位符

**操作步骤：**
1. 双击第一个位置 → 选择"姓名" → 插入
2. 双击第二个位置 → 选择"出生日期" → 插入
3. 双击第三个位置 → 选择"住址" → 插入
4. ...

**优势：**
- 无需切换模式
- 可见即可插
- 连续操作流畅

---

## 🎨 视觉反馈

### 双击响应
```
双击位置 →  立即弹出插入器
          （无延迟）
```

### 插入反馈
```
选择占位符 →  文档立即更新
            显示彩色chip
          →  toast提示："插入成功"
```

### 搜索反馈
```
输入关键词 →  实时筛选列表
            （无需按回车）
```

---

## 💡 用户提示

在模式2的文档预览区下方显示：

```
┌────────────────────────────────────────────────┐
│ 💡 提示：                                       │
│ 双击文档任意位置插入占位符 ·                     │
│ 点击彩色chip配置占位符 ·                        │
│ 右键打开更多选项                                │
└────────────────────────────────────────────────┘
```

---

## 🔧 技术实现

### 核心组件

#### 1. PlaceholderInserter（占位符插入器）
**文件：** `frontend/components/template-editor/placeholder-inserter.tsx`

**功能：**
- 占位符搜索和选择
- 快速创建新占位符
- 响应式布局

#### 2. DocumentPreviewInteractive（交互式预览）
**文件：** `frontend/components/template-editor/document-preview-interactive.tsx`

**功能：**
- 双击事件捕获
- 右键菜单
- 在指定位置插入占位符
- chip点击配置

### 关键实现

#### 捕获双击位置
```typescript
editorProps: {
  handleDoubleClick: (view, pos, event) => {
    setInsertPosition(pos)  // 记录位置
    setInserterOpen(true)   // 打开插入器
    return true
  }
}
```

#### 在指定位置插入
```typescript
const handleSelectPlaceholder = (fieldKey: string) => {
  editor
    .chain()
    .focus()
    .insertContentAt(insertPosition, `{{${fieldKey}}}`)
    .run()
}
```

#### 智能搜索
```typescript
const filteredPlaceholders = useMemo(() => {
  if (!searchQuery) return allPlaceholders
  
  const keyword = searchQuery.toLowerCase()
  return allPlaceholders.filter(p =>
    p.label.toLowerCase().includes(keyword) ||
    p.fieldKey.toLowerCase().includes(keyword)
  )
}, [allPlaceholders, searchQuery])
```

---

## 📱 跨设备支持

| 设备 | 双击 | 右键 | 体验 |
|------|------|------|------|
| **桌面** | ✅ | ✅ | 完美 |
| **平板** | ✅ | ⚠️ 长按 | 良好 |
| **手机** | ✅ | ⚠️ 长按 | 可用 |

---

## 🎯 用户体验优化

### 1. 即时反馈
- 双击立即响应（< 100ms）
- 搜索实时筛选
- 插入无延迟

### 2. 减少步骤
```
旧方案：5步
1. 点击左侧"新建"
2. 填写配置
3. 保存
4. 切换到编辑模式
5. 手动输入 {{name}}

新方案：2步
1. 双击位置
2. 选择占位符
```

### 3. 空间直觉
- 用户看到位置 → 直接点击
- 无需记忆字段名
- 无需切换模式

---

## 🚀 未来增强

### Phase 2（可选）
- [ ] 拖拽支持（从列表拖到文档）
- [ ] 键盘快捷键（Ctrl+Space插入）
- [ ] 选中文本转换为占位符
- [ ] 占位符使用统计

### Phase 3（高级）
- [ ] AI智能建议占位符
- [ ] 模板片段快速插入
- [ ] 批量替换工具

---

## 📖 相关文档

- `THREE_MODE_ARCHITECTURE.md` - 三模式架构说明
- `README_NEW_ARCHITECTURE.md` - 技术架构文档
- `TEMPLATE_EDITOR_REFACTOR_SUMMARY.md` - 重构总结

---

**更新日期：** 2025-11-21  
**功能版本：** 4.0  
**状态：** ✅ 已实现并可用


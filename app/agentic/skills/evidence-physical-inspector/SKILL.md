---
name: evidence-physical-inspector
description: |
  当需要识别证据物理特征、判断证据类型、提取证据槽位或校对证据信息时，使用此技能执行：
  1. 根据视觉特征识别证据类型（18种类型）
  2. 按decisive/important/common三级特征进行分类
  3. 区分关联证据与独立证据，执行不同的提取逻辑
  4. 执行证据槽位提取和信息校验
  5. 处理脱敏匹配和当事人关联
  6. 按场景规则验证证据完整性
---

# 证据物理特征识别

## 快速开始

当需要分析证据图片或判断证据类型时：

### Step 1: 识别证据类型

根据图片的视觉特征，按三级特征判断：

| 特征级别 | 定义 | 要求 |
|----------|------|------|
| **decisive** | 决定性特征 | 必须存在才能分类为该类型 |
| **important** | 重要特征 | 辅助判断，增强可信度 |
| **common** | 常见特征 | 参考信息，可能存在 |

**判断逻辑**：
1. 先检查是否存在某个类型的 **decisive 特征**
2. 再检查 **important 特征** 的数量
3. 排除规则：检查是否属于其他类型

### Step 2: 区分证据处理模式

**核心判断**：证据是独立证据还是关联证据？

| 特征 | 独立证据 | 关联证据 |
|------|----------|----------|
| **card_is_associated** | False | True |
| **证据图片数** | 单个图片 | 多个图片 |
| **提取方式** | 单个提取 | 批量分组提取 |
| **分组依据** | 无 | slot_group_name |
| **顺序信息** | 无 | sequence_number |
| **典型类型** | 身份证、营业执照、转账记录 | 微信聊天记录（多图） |

**判断规则**：
- 如果证据类型是**微信聊天记录**且有多张图片 → 关联证据
- 如果证据类型是**短信聊天记录**且有多张图片 → 关联证据
- 其他类型通常是独立证据

### Step 3: 执行槽位提取

#### 独立证据提取
根据证据类型，从单张图片中提取结构化信息：

```yaml
slot_name: "xxx"           # 槽位名称
slot_value: "xxx"          # 提取的值
slot_value_type: "string"  # 值类型：string/number/boolean/date
confidence: 0.95           # 置信度
reasoning: "提取推理"       # 说明如何提取的
```

#### 关联证据提取（多图分组）

**关键步骤**：
1. **识别分组标识**：从所有图片中识别关键标识（如微信备注名）
2. **按标识分组**：将相同标识的图片分为一组
3. **记录序列信息**：为每张图片分配 sequence_number
4. **批量提取**：分析组内所有图片提取词槽
5. **关联上下文**：记录每个词槽来源于哪些图片

```yaml
# 关联证据的槽位输出格式
ResultItem:
  slot_group_name: "微信备注名"  # 分组标识
  image_sequence_info:
    - url: "图片1 URL"
      sequence_number: 1
    - url: "图片2 URL"
      sequence_number: 2
  slot_extraction:
    - slot_name: "欠款金额"
      slot_value: 5000
      slot_group_info:  # 槽位来源信息
        - group_name: "微信备注名"
          group_sequence_number: 1
          reference_evidence_ids: [evidence_id_1]
```

### Step 4: 执行信息校验

根据校对规则校验提取的信息：

**校验类型**：
- **案件字段校验**：校验欠款金额等案件字段
- **当事人字段校验**：校验姓名、身份等当事人字段

**匹配策略**：
- **exact**：精确匹配
- **fuzzy**：模糊匹配（支持脱敏字符如"翁**"匹配"翁文达"）

### Step 5: 关联当事人角色

根据校验结果自动标注证据角色：

| 角色 | 说明 |
|------|------|
| **creditor** | 债权人 |
| **debtor** | 债务人 |

## 证据类型与物理特征对照表

### 通讯聊天类

| 类型 | Decisive特征 | Important特征 | 处理模式 |
|------|--------------|---------------|----------|
| **微信聊天记录** | 微信聊天界面、聊天气泡布局 | 对话内容、转账收款信息、用户头像、时间戳 | **关联**（多图分组） |
| **微信个人主页** | 微信个人主页、发消息按钮 | 个人头像、昵称、微信号、地区 | 独立 |
| **短信聊天记录** | 手机系统短信、短信气泡 | 短信内容、发送接收时间、发件人手机号 | **关联**（多图分组） |
| **支付宝转账页面** | 支付宝转账、确认付款按钮、Logo | 收款方账户、金额、蓝色主色调 | 独立 |

### 交易记录类

| 类型 | Decisive特征 | Important特征 | 处理模式 |
|------|--------------|---------------|----------|
| **微信支付转账电子凭证** | 转账电子凭证、腾讯支付Logo、财付通、业务凭证专用章 | 红色圆形印章、表格化交易详情、转账单号、付款方收款方信息 | 独立 |
| **微信转账记录** | 黄色钱袋子icon、转账时间、转账单号 | 支付成功、零钱通、金额 | 独立 |
| **银行转账记录** | 银行Logo、交易流水号、银行回单格式 | 付款人账号户名、收款人账号户名、交易金额、交易时间 | 独立 |

### 票据类

| 类型 | Decisive特征 | Important特征 | 处理模式 |
|------|--------------|---------------|----------|
| **借款借条** | 借款、借钱、借到、借款借条 | 欠条、利息、借款人签名、身份证号 | 独立 |
| **货款欠条** | 货款、货款欠条、欠货款、货、货物、商品、买卖 | 欠条、金额、还款、拿货 | 独立 |
| **增值税发票** | 增值税专用/普通发票、发票监制章、发票代码、号码 | 购买方信息、销售方信息、金额合计、税额、二维码 | 独立 |

### 个人身份证明类

| 类型 | Decisive特征 | Important特征 | 处理模式 |
|------|--------------|---------------|----------|
| **身份证** | 中华人民共和国居民身份证、国徽、长城图案、签发机关 | 姓名、性别、民族、出生、住址、公民身份号码、个人头像 | 独立 |
| **户籍档案** | 居民户口簿、公安机关户口专用章、户主页、常住人口登记卡 | 户号、姓名、与户主关系、红色公章 | 独立 |
| **经常居住地证明** | 居住证明、流动人口信息登记表、红色公章、官方机构名称 | 住址、姓名、身份证号、派出所、社区居委会 | 独立 |

### 经营资质证明类

| 类型 | Decisive特征 | Important特征 | 处理模式 |
|------|--------------|---------------|----------|
| **公司营业执照** | 营业执照、国徽图标、红色印章、市场监督管理局 | 统一社会信用代码、公司名称、法定代表人、成立日期 | 独立 |
| **个体工商户营业执照** | 个体工商户营业执照、国徽、红色印章、市场监督管理局 | 统一社会信用代码、经营者姓名、经营场所 | 独立 |
| **公司全国企业公示系统截图** | 国家企业信用信息公示系统、企业信用信息、网页布局 | 统一社会信用代码、法定代表人、网页UI元素 | 独立 |

## 关联证据处理详解

### 微信聊天记录（关联证据）

**分组逻辑**：
- 通过 `微信备注名` 将同一对话的多张截图关联
- 每个不同的备注名创建一个独立的卡片

**槽位提取**：
| 槽位 | 是否必需 | 说明 |
|------|----------|------|
| `微信备注名` | 是 | 分组标识，必填 |
| `欠款合意` | 是 | 债务人是否承认欠款（boolean） |
| `欠款金额` | 是 | 欠款数值（number） |
| `约定还款日期` | 否 | 约定还款时间（date） |
| `约定还款利息` | 否 | 利息率（number） |

**欠款合意判断标准**（必须同时满足）：
1. 有明确的文字表述
2. 债务人明确承认欠款："我确实欠你钱"、"我会还的"等
3. 债务人确认具体金额："是的，就是5000元"
4. 债务人承诺还款："我会还的"、"我尽快还"

**以下情况不能作为欠款合意的证据**：
- 音频气泡没有转文字内容
- 债务人发送的无关截图
- 债权人单方面的要求或陈述
- 模糊不清或可解释为其他含义的表述

**图片序列示例**：
```yaml
ResultItem:
  slot_group_name: "张三"
  image_sequence_info:
    - url: "图片1.jpg"
      sequence_number: 1  # 第1张，时间最早
    - url: "图片2.jpg"
      sequence_number: 2  # 第2张
    - url: "图片3.jpg"
      sequence_number: 3  # 第3张，时间最晚
  slot_extraction:
    - slot_name: "欠款金额"
      slot_value: 5000
      slot_value_type: "number"
      confidence: 0.95
```

### 独立证据处理示例

**身份证**：
```yaml
slot_extraction:
  - slot_name: "姓名"
    slot_value: "张三"
    slot_value_type: "string"
    confidence: 1.0
  - slot_name: "公民身份号码"
    slot_value: "310101199001011234"
    slot_value_type: "string"
    confidence: 1.0
```

**微信支付转账电子凭证**：
```yaml
slot_extraction:
  - slot_name: "付款方真名"
    slot_value: "张三"
    slot_value_type: "string"
    confidence: 1.0
  - slot_name: "收款方真名"
    slot_value: "李四"
    slot_value_type: "string"
    confidence: 1.0
  - slot_name: "转账金额"
    slot_value: 1000
    slot_value_type: "number"
    confidence: 1.0
```

## 脱敏匹配规则

当证据中的姓名被脱敏显示时（如"翁**"），使用模糊匹配：

```python
def _is_masked_match(masked_value: str, full_value: str) -> bool:
    """脱敏值匹配完整值
    "翁**" 匹配 "翁文达"
    """
    import re
    pattern = re.escape(masked_value).replace(r'\*', '.')
    return bool(re.match(f"^{pattern}$", full_value, re.IGNORECASE))
```

**适用场景**：
- 微信转账页面显示的脱敏姓名
- 支付宝转账页面的脱敏姓名
- 银行卡号中间隐藏

## 排除规则

每种证据类型都有排除规则，防止误分类：

**微信聊天记录排除**：
- 如果只包含单条转账记录 → 优先考虑"微信转账记录"
- 如果是个人主页 → 为"微信主页"

**微信转账页面排除**：
- 转账完成后的截图
- 聊天记录中的转账消息
- 转账记录详情

## 证据完整性验证

根据案由和场景规则，验证证据是否完整：

**示例 - 民间借贷纠纷**：
- 需要：借款人身份证、借款借条、转账记录
- 可选：微信聊天记录（证明合意）、催款记录（证明诉讼时效）

## 相关技能

- `evidence-authenticator` - 证据审核认定
- `evidence-identifier` - 证据类型识别
- `wechat-evidence-saver` - 微信证据保存
- `electronic-evidence-reviewer` - 电子数据真实性审查

# Design: 表格格式一致性优化

## Context

当前系统使用 Tiptap 作为富文本编辑器，通过自定义扩展支持表格功能。用户从 WPS 复制表格内容到编辑器时，会遇到以下问题：

1. **容器宽度限制**：`.template-doc` 容器的宽度被限制为 `A4_CONTENT_WIDTH = 602px`，这比 WPS 中的表格可能更窄
2. **表格宽度处理**：表格使用 `width: 100%`，但受限于容器宽度，导致从 WPS 复制的宽表格被压缩
3. **字体大小不一致**：粘贴时字体大小可能不一致，导致单元格内容换行
4. **列宽信息丢失**：从 WPS 复制时，列宽信息可能没有正确保留

## Goals / Non-Goals

### Goals
- 保持从 WPS 粘贴的表格格式与源文档一致
- 确保表格宽度和列宽比例正确保留
- 统一表格字体大小，避免因字体导致的布局问题
- 提供水平滚动支持，允许宽表格正常显示

### Non-Goals
- 不改变现有的表格数据结构（继续使用 Tiptap 标准格式）
- 不实现表格样式的高级定制（如边框样式、背景色渐变等）
- 不改变 A4 纸张的视觉尺寸（保持 794px 宽度）

## Decisions

### 1. 表格宽度处理策略

**决策**：采用"保留原始宽度 + 水平滚动"的策略

**实现方案**：
- 在粘贴时检测表格的原始宽度
- 如果表格宽度超过容器宽度，保留原始宽度并使用水平滚动
- 如果表格宽度小于容器宽度，使用 `width: 100%` 填充容器
- 使用 `table-layout: fixed` 配合 `colgroup` 来保持列宽比例

**理由**：这样可以最大程度保留 WPS 表格的原始格式，同时通过滚动解决容器宽度限制问题。

### 2. 列宽信息提取和保留

**决策**：在 `transformPastedHTML` 中提取列宽信息，并转换为 Tiptap 的 `colWidths` 属性

**实现方案**：
- 检测粘贴内容中的 `<col>` 或 `<colgroup>` 元素
- 提取每列的宽度值（支持 px、pt、% 等单位）
- 将宽度转换为 twips（Tiptap 使用的单位）
- 在表格节点中保存 `colWidths` 属性
- 在渲染时使用 `colgroup` 和 `col` 元素应用列宽

**理由**：Tiptap 的表格扩展支持 `colWidths` 属性，可以正确保留列宽信息。

### 3. 字体统一处理

**决策**：在粘贴时统一表格单元格的字体大小

**实现方案**：
- 检测表格单元格中的字体大小
- 如果字体大小差异较大（超过 2pt），统一为默认字体大小（14px）
- 保留字体样式（如加粗、斜体等），但统一字体大小
- 确保表格单元格使用一致的字体族

**理由**：字体大小不一致会导致单元格高度和宽度变化，影响表格布局。统一字体大小可以确保表格格式稳定。

### 4. 容器布局优化

**决策**：允许表格容器水平滚动，但保持 A4 纸张的视觉效果

**实现方案**：
- 在 `.template-doc-container` 上添加 `overflow-x: auto`
- 保持容器宽度为 A4 纸张宽度（794px）
- 允许内容超出时显示水平滚动条
- 确保表格在容器中正确对齐

**理由**：保持 A4 纸张的视觉效果，同时允许宽表格正常显示。

## Risks / Trade-offs

### 风险 1：水平滚动可能影响用户体验
**风险**：用户可能不习惯水平滚动，特别是对于宽表格
**缓解**：提供视觉提示（如滚动条），并确保滚动行为流畅

### 风险 2：列宽转换可能不准确
**风险**：不同单位的转换（px、pt、% 等）可能导致列宽不准确
**缓解**：使用精确的转换公式，并在粘贴后进行验证和调整

### 风险 3：字体统一可能丢失重要格式信息
**风险**：统一字体大小可能丢失源文档中的格式意图
**缓解**：只统一明显异常的字体大小（差异超过 2pt），保留合理的字体大小差异

## Migration Plan

1. **阶段 1**：优化粘贴处理逻辑，提取和保留列宽信息
2. **阶段 2**：优化表格样式，支持水平滚动
3. **阶段 3**：统一字体处理，确保表格格式一致
4. **阶段 4**：测试和验证，确保所有场景正常工作

## Open Questions

- 是否需要提供用户选项来控制表格宽度处理策略（保留原始宽度 vs 自适应容器）？
- 对于非常宽的表格（超过 1200px），是否应该自动缩放以适应容器？


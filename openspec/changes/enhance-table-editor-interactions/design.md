# Design: 表格编辑器增强功能

## Context

当前系统使用 Tiptap 作为富文本编辑器，通过自定义扩展支持表格功能。表格编辑器基于 `@tiptap/extension-table` 系列扩展，并已实现基础的表格操作（添加/删除行列、调整列宽）。

用户需要更强大的表格编辑能力，特别是：
1. 处理从 WPS 粘贴的表格内容时保持格式一致性
2. 支持类似 WPS 的单元格级别操作（插入、删除、合并、拆分）

## Goals / Non-Goals

### Goals
- 解决 WPS 粘贴时内容超出单元格的问题
- 实现单元格级别的插入和删除操作
- 实现单元格合并和拆分功能
- 提供直观的用户界面（工具栏按钮 + 右键菜单）
- 确保所有操作与 WPS 行为一致

### Non-Goals
- 不改变现有的表格数据结构（继续使用 Tiptap 标准格式）
- 不实现表格样式的高级定制（如边框样式、背景色渐变等）
- 不实现表格嵌套功能
- 不实现表格排序功能

## Decisions

### 1. WPS 粘贴处理优化

**决策**：在 `transformPastedHTML` 中增强表格单元格处理逻辑

**实现方案**：
- 检测粘贴内容中的表格单元格（`<td>`, `<th>`）
- 移除可能导致溢出的样式（如 `width: auto`, `min-width` 过大值）
- 确保单元格使用 `box-sizing: border-box`
- 添加 `word-wrap: break-word` 和 `overflow-wrap: break-word` 确保长文本换行
- 限制单元格内容的最大宽度为单元格宽度

**理由**：WPS 导出的 HTML 可能包含绝对宽度或自动宽度，导致内容溢出。通过规范化样式可以确保内容适配单元格。

### 2. 单元格插入操作

**决策**：扩展 Tiptap Table 扩展，添加 `insertCellAbove` 和 `insertCellBelow` 命令

**实现方案**：
- 检测当前光标所在的单元格位置
- 在相同列的上方或下方插入新单元格
- 如果当前单元格是合并单元格，需要特殊处理（插入到合并区域的边界）
- 更新表格结构，确保所有行的单元格数量一致

**理由**：Tiptap 默认只支持整行插入，我们需要在 Table 扩展层面添加单元格级别的操作。

### 3. 单元格删除操作

**决策**：实现 `deleteCell` 命令，删除后自动调整表格结构

**实现方案**：
- 如果删除的单元格不是合并单元格，直接删除并调整后续单元格位置
- 如果删除的单元格是合并单元格的一部分，需要拆分合并区域
- 如果删除后某行单元格数量为 0，删除整行
- 如果删除后某列单元格数量为 0，删除整列

**理由**：单元格删除比整行/整列删除更灵活，但需要处理边界情况。

### 4. 单元格合并操作

**决策**：使用 Tiptap 现有的 `colspan` 和 `rowspan` 属性实现合并

**实现方案**：
- 检测选中的单元格区域（矩形区域）
- 计算合并后的 `colspan` 和 `rowspan` 值
- 将选中区域的所有单元格合并为第一个单元格
- 删除被合并的其他单元格
- 更新表格结构

**理由**：Tiptap 已经支持 `colspan` 和 `rowspan`，我们只需要实现合并逻辑。

### 5. 单元格拆分操作

**决策**：将合并单元格拆分为原始结构

**实现方案**：
- 检测当前单元格的 `colspan` 和 `rowspan` 值
- 创建相应数量的新单元格
- 将原单元格内容复制到第一个新单元格
- 更新表格结构

**理由**：拆分是合并的逆操作，需要恢复原始单元格结构。

### 6. 用户界面设计

**决策**：工具栏按钮 + 右键菜单双重支持

**实现方案**：
- 在工具栏中添加合并/拆分按钮（使用图标：Merge/UnMerge）
- 在单元格上添加右键菜单，包含所有表格操作
- 根据当前选择状态动态启用/禁用按钮

**理由**：工具栏适合常用操作，右键菜单提供完整功能集，两者结合提供最佳用户体验。

## Risks / Trade-offs

### 风险 1：合并单元格的复杂性
- **风险**：处理合并单元格的插入/删除操作时，逻辑可能变得复杂
- **缓解**：先实现基础功能，逐步处理边界情况，添加充分的测试

### 风险 2：性能问题
- **风险**：频繁的表格结构变更可能导致渲染性能下降
- **缓解**：使用 Tiptap 的批量更新机制，减少不必要的重渲染

### 风险 3：与现有功能的兼容性
- **风险**：新功能可能与现有的表格导出功能冲突
- **缓解**：确保合并单元格在导出时正确映射到 DOCX 格式（已有相关代码）

## Migration Plan

1. **阶段 1**：优化 WPS 粘贴处理（不影响现有功能）
2. **阶段 2**：实现单元格插入和删除功能
3. **阶段 3**：实现单元格合并和拆分功能
4. **阶段 4**：添加右键菜单和优化 UI
5. **阶段 5**：测试和修复边界情况

每个阶段完成后进行测试，确保不影响现有功能。

## Open Questions

1. 单元格删除时，如果删除后表格结构不完整，是否应该阻止删除？
   - **建议**：允许删除，但自动清理空行/空列

2. 合并单元格时，如果选中的区域包含已合并的单元格，如何处理？
   - **建议**：先拆分已合并的单元格，再进行新的合并

3. 右键菜单是否应该在所有编辑器实例中统一实现？
   - **建议**：先实现文档编辑器，后续扩展到模板编辑器


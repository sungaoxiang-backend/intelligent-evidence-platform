# Design: 拆分文书管理和文书制作功能

## Context

当前"文书管理"模块同时承担了模板管理和文书制作两个职责。用户需要将这两个职责分离，并增加案件关联和草稿功能。

## Goals / Non-Goals

### Goals
- 清晰分离模板管理和文书制作两个职责
- 支持案件关联，每个文书制作实例关联到一个案件
- 支持草稿功能，用户可以保存填写进度
- 保持现有模板管理功能的完整性

### Non-Goals
- 不改变现有模板的数据结构
- 不改变现有模板管理的核心功能
- 不涉及案件管理模块的修改（仅关联）

## Decisions

### 1. 数据模型设计

**DocumentDraft 模型**
- 存储案件ID (`case_id`) 和模板ID (`document_id`) 的组合
- 存储表单数据 (`form_data`: JSON格式)
- 支持唯一约束：每个案件+模板组合只有一个草稿
- 包含创建和更新时间戳

**理由**：
- 简单直接，满足需求
- 唯一约束确保数据一致性
- JSON格式灵活，支持各种表单字段类型

### 2. 页面职责划分

**文书管理页面 (`/documents`)**
- 仅显示和管理文书模板（Document模型）
- 支持创建、编辑、预览、发布模板
- 支持按状态筛选（草稿/已发布）
- 移除表单填写和生成功能

**文书制作页面 (`/document-creation`)**
- 第一步：选择案件
- 第二步：选择已发布的模板
- 第三步：填写表单（基于模板的占位符元数据）
- 支持草稿自动保存和加载
- 支持预览和下载填充后的文档

**理由**：
- 职责清晰，用户流程明确
- 符合用户需求描述

### 3. 草稿管理策略

**手动保存机制**：
- 用户填写表单时，系统检测表单数据是否有更新
- 当表单数据有更新时：
  - "保存草稿"按钮变为可点击状态（高亮显示）
  - "下载文书"按钮变为不可点击状态（禁用）
- 用户点击"保存草稿"按钮后：
  - 保存草稿到服务器
  - "保存草稿"按钮变为不可点击状态（置灰）
  - "下载文书"按钮变为可点击状态（启用）
- 如果表单数据与已保存的草稿一致，按钮状态保持为已保存状态

**自动加载**：
- 用户选择案件和模板后，自动查询是否存在草稿
- 如果存在，自动加载草稿数据并填充到表单
- 加载草稿后，按钮初始状态为已保存状态（保存按钮置灰，下载按钮可点击）

**唯一性**：
- 每个案件+模板组合只有一个草稿
- 更新操作使用 upsert 模式（存在则更新，不存在则创建）

**理由**：
- 手动保存机制给用户更多控制权，避免意外保存
- 按钮状态管理清晰，防止用户下载未保存的草稿
- 自动加载提升用户体验，减少重复输入

### 4. API设计

**草稿相关API**：
- `GET /api/v1/document-drafts?case_id={case_id}&document_id={document_id}` - 获取草稿
- `POST /api/v1/document-drafts` - 创建或更新草稿
- `DELETE /api/v1/document-drafts/{draft_id}` - 删除草稿

**文书制作相关API**：
- `GET /api/v1/documents/published` - 获取已发布模板列表（用于文书制作页面）
- `POST /api/v1/document-creation/generate` - 生成填充后的文档（基于表单数据）

**理由**：
- RESTful设计，符合现有API风格
- 清晰的资源划分

## Risks / Trade-offs

### 风险
1. **数据迁移**：现有"文书管理"页面中的表单填写功能需要移除，但不会影响已有数据
2. **用户体验**：用户需要适应新的页面分离，但流程更清晰

### 权衡
- **草稿存储位置**：选择存储在独立的 `DocumentDraft` 表中，而不是在 `Document` 表中，因为草稿是案件相关的，而模板是全局的
- **保存机制**：选择手动保存而非自动保存，给用户更多控制权，同时通过按钮状态管理防止数据不一致

## Migration Plan

1. **数据库迁移**：
   - 创建 `DocumentDraft` 表
   - 添加必要的索引

2. **后端实现**：
   - 实现 `DocumentDraft` 模型
   - 实现草稿管理服务
   - 实现草稿相关API

3. **前端实现**：
   - 创建"文书制作"页面
   - 修改"文书管理"页面，移除表单填写功能
   - 更新导航栏

4. **测试**：
   - 测试草稿的创建、更新、查询、删除
   - 测试文书制作的完整流程
   - 测试案件关联功能

## Open Questions

- 草稿是否需要支持版本历史？（当前设计不支持，如需要可后续扩展）
- 草稿是否需要支持多用户协作？（当前设计不支持，如需要可后续扩展）

